---
// LinkList component - displays user's shortlinks
---

<section id="link-list-section" class="hidden mt-16 animate-slide-up" style="animation-delay: 0.1s">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-2">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white">æˆ‘çš„çŸ­é“¾</h2>
      <span id="link-count" class="px-2 py-0.5 rounded-full bg-gray-100 dark:bg-white/5 text-[10px] font-bold text-gray-400 dark:text-slate-500 uppercase tracking-widest"></span>
    </div>
  </div>

  <!-- Loading state -->
  <div id="link-list-loading" class="hidden space-y-4">
    {[1, 2].map(() => (
      <div class="card p-5 opacity-60">
        <div class="flex justify-between mb-4">
          <div class="skeleton h-6 w-24"></div>
          <div class="skeleton h-6 w-12"></div>
        </div>
        <div class="skeleton h-4 w-full mb-3"></div>
        <div class="flex justify-between items-center">
          <div class="skeleton h-3 w-32"></div>
          <div class="flex gap-2">
            <div class="skeleton h-8 w-16"></div>
            <div class="skeleton h-8 w-16"></div>
          </div>
        </div>
      </div>
    ))}
  </div>

  <!-- Link list -->
  <div id="link-list" class="space-y-4"></div>

  <!-- Empty state -->
  <div id="link-list-empty" class="hidden flex flex-col items-center justify-center py-20 bg-gray-50/50 dark:bg-slate-900/30 rounded-3xl border-2 border-dashed border-gray-100 dark:border-white/5">
    <div class="w-16 h-16 rounded-2xl bg-white dark:bg-slate-800 shadow-soft flex items-center justify-center text-2xl mb-4">
      ğŸ“¦
    </div>
    <p class="text-base font-semibold text-gray-900 dark:text-white mb-1">æš‚æ— çŸ­é“¾</p>
    <p class="text-sm text-gray-400 dark:text-slate-500">åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªçŸ­é“¾æ¥ï¼Œå¼€å¯é«˜æ•ˆç®¡ç†</p>
  </div>
</section>

<!-- Link item template -->
<template id="link-item-template">
  <div class="link-item relative group bg-white dark:bg-slate-900 border border-gray-100 dark:border-white/5 rounded-2xl p-5 hover:border-primary-200 dark:hover:border-primary-900/50 hover:shadow-soft transition-all" data-code="">
    <div class="flex items-start justify-between gap-4 mb-3">
      <div class="flex items-center gap-3">
        <a
          href="#"
          target="_blank"
          rel="noopener noreferrer"
          class="link-code text-lg font-bold text-gray-900 dark:text-white hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
        ></a>
        <span class="link-disabled hidden px-2 py-0.5 text-[10px] font-bold bg-amber-50 text-amber-600 dark:bg-amber-900/20 dark:text-amber-400 rounded-md uppercase tracking-wider">
          å·²ç¦ç”¨
        </span>
      </div>
      <div class="flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
        <button type="button" class="btn-stats p-2 text-gray-400 hover:text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-all" title="æŸ¥çœ‹ç»Ÿè®¡">
          <svg class="w-4.5 h-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20v-6M6 20V10M18 20V4"></path>
          </svg>
        </button>
        <button type="button" class="btn-qr p-2 text-gray-400 hover:text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-all" title="æ˜¾ç¤ºäºŒç»´ç ">
          <svg class="w-4.5 h-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
          </svg>
        </button>
        <button type="button" class="btn-remove p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-lg transition-all" title="åˆ é™¤">
          <svg class="w-4.5 h-4.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"></path>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      </div>
    </div>

    <p class="link-url text-sm text-gray-500 dark:text-slate-400 truncate mb-4 font-medium"></p>

    <div class="flex items-center justify-between pt-4 border-t border-gray-50 dark:border-white/5">
      <div class="flex items-center gap-4">
        <span class="link-time text-xs text-gray-400 dark:text-slate-500 flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span class="time-text"></span>
        </span>
      </div>
      <div class="flex items-center gap-1.5">
        <button type="button" class="btn-copy-list text-[10px] font-bold text-primary-600 dark:text-primary-400 uppercase tracking-widest hover:underline">
          å¤åˆ¶çŸ­é“¾
        </button>
      </div>
    </div>
  </div>
</template>

<script>
  // Format date
  function formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (days === 0) {
      const hours = Math.floor(diff / (1000 * 60 * 60));
      if (hours === 0) {
        const minutes = Math.floor(diff / (1000 * 60));
        return minutes <= 1 ? 'åˆšåˆš' : `${minutes}åˆ†é’Ÿå‰`;
      }
      return `${hours}å°æ—¶å‰`;
    } else if (days === 1) {
      return 'æ˜¨å¤©';
    } else if (days < 7) {
      return `${days}å¤©å‰`;
    } else if (days < 30) {
      return `${Math.floor(days / 7)}å‘¨å‰`;
    } else {
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }
  }

  // Render link list (called from main script)
  (window as any).renderLinkList = function(links: any[]) {
    const listEl = document.getElementById('link-list');
    const emptyEl = document.getElementById('link-list-empty');
    const loadingEl = document.getElementById('link-list-loading');
    const countEl = document.getElementById('link-count');
    const template = document.getElementById('link-item-template') as HTMLTemplateElement;

    if (!listEl || !template) return;

    loadingEl?.classList.add('hidden');

    if (!links || links.length === 0) {
      listEl.innerHTML = '';
      emptyEl?.classList.remove('hidden');
      if (countEl) countEl.textContent = '';
      return;
    }

    emptyEl?.classList.add('hidden');
    if (countEl) countEl.textContent = `å…± ${links.length} æ¡`;

    listEl.innerHTML = '';

    links.forEach(link => {
      const clone = template.content.cloneNode(true) as DocumentFragment;
      const item = clone.querySelector('.link-item') as HTMLElement;
      const codeEl = clone.querySelector('.link-code') as HTMLAnchorElement;
      const urlEl = clone.querySelector('.link-url') as HTMLElement;
      const timeEl = clone.querySelector('.time-text') as HTMLElement;
      const disabledEl = clone.querySelector('.link-disabled') as HTMLElement;
      const actionsEl = clone.querySelector('.link-actions') as HTMLElement;
      const qrBtn = clone.querySelector('.btn-qr') as HTMLButtonElement;
      const removeBtn = clone.querySelector('.btn-remove') as HTMLButtonElement;
      const copyListBtn = clone.querySelector('.btn-copy-list') as HTMLButtonElement;
      const statsBtn = clone.querySelector('.btn-stats') as HTMLButtonElement;

      const shortUrl = `${window.location.origin}/${link.code}`;

      item.dataset.code = link.code;
      codeEl.textContent = link.code;
      codeEl.href = shortUrl;
      urlEl.textContent = link.url;
      urlEl.title = link.url;
      timeEl.textContent = formatDate(link.created_at);

      if (link.disabled) {
        disabledEl.classList.remove('hidden');
        codeEl.classList.add('line-through', 'opacity-60');
        urlEl.classList.add('opacity-60');
        // Hide QR button for disabled links
        qrBtn.classList.add('hidden');
        statsBtn.classList.add('hidden');
      }

      // QR button click
      qrBtn.addEventListener('click', () => {
        (window as any).showQRModal?.(shortUrl, link.code);
      });

      // Stats button click
      statsBtn.addEventListener('click', () => {
        (window as any).showStatsModal?.(link.code);
      });

      // Remove button click
      removeBtn.addEventListener('click', () => {
        (window as any).removeShortlink?.(link.code);
      });

      // Copy button click
      copyListBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(shortUrl);
          const originalText = copyListBtn.textContent;
          copyListBtn.textContent = 'å·²å¤åˆ¶';
          setTimeout(() => {
            copyListBtn.textContent = originalText;
          }, 1500);
        } catch (err) {
          console.error('Copy failed', err);
        }
      });

      listEl.appendChild(clone);
    });
  };

  // Show loading state
  (window as any).showLinkListLoading = function() {
    const loadingEl = document.getElementById('link-list-loading');
    const listEl = document.getElementById('link-list');
    const emptyEl = document.getElementById('link-list-empty');

    loadingEl?.classList.remove('hidden');
    if (listEl) listEl.innerHTML = '';
    emptyEl?.classList.add('hidden');
  };
</script>
